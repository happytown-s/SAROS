# 波形アラインメントの精度向上と同期修正 (2026/01/10)

## 1. 概要
ユーザーから報告された「波形表示が3時（プレイヘッド開始点）からズレる」問題、および「x2トラックでの表示オフセット」を完全に解消するため、録音同期ロジックの抜本的な改善とサンプル単位での精度向上を行いました。

## 2. 実装の詳細（Implementation Plan より）

### サンプル精度でのトリガー位置伝達
従来のブロック単位（約10ms）での処理を廃止し、サンプル単位で正確なトリガー検知を行うようにしました。
- **AudioInputBuffer**: ブロック内のサンプルインデックス `lastTriggerIndexInBlock` を捕捉。
- **InputManager**: `TriggerEvent` に正確なサンプルオフセットをセットして LooperAudio へ伝達。

### 同期位置の微調整ロジック
- **LooperAudio**: `masterStartSample`（基準時間）に対し、トリガーが行われた「瞬間」のサンプルオフセットを加味して `writePosition`（書き込み位置）を決定。
- **Visualizerオフセット**: 録音された音の出だしを3時の位置に強制的に揃えるため、`recordStartSample` をマスター同期基準点から計算するように修正。

## 3. 修正の歩み（Walkthrough より）

### スレーブトラック同期ズレ修正
再生開始時の位置計算を録音時と同じ「絶対位置（`currentSamplePos`）ベース」に統一し、誤差を排除しました。

### スマート位相アラインメント（x2トラック対応）
x2トラックの録音開始時、マスターが奇数周目（裏）にいた場合、自動的にグローバル位相をリセットして表拍（3時）から始まるように調整する機能を実装。

### バッファサイズの適正化
録音開始時に、バッファを（マスター長×倍率）に合わせて正確にリサイズ。これにより波形が円周全体に正しく展開されるようになりました。

### 停止・クリア時の正常化
- 停止時に `readPosition` を0にリセット（常に先頭から再生）。
- クリア時に倍率設定（x2など）と録音トリガータイマーをリセット。

## 4. 最終的な結果
- **3時基準の徹底**: 等倍・倍速にかかわらず、録音された音の立ち上がりが3時の位置に正確に一致。
- **視覚と音の完全同期**: ブロック単位のラグ（最大10ms）が排除され、波形表示と実際の再生音がミリ秒単位で同期。
- **直感的な操作感**: どこで録音を始めても、ループサイクル上の正しい位相に配置される信頼性の高い挙動を実現。
