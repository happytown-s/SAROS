# System Audio Capture (ScreenCaptureKit) 統合

## 1. 概要
macOS 12.3以降（本実装では13.0+推奨）で利用可能な `ScreenCaptureKit` フレームワークを利用し、仮想オーディオドライバ（BlackHole等）なしでシステム音声を直接キャプチャする機能を実装しました。

### 主な特徴
- **ドライバ不要**: ユーザーは追加のソフトウェアをインストールする必要がありません。
- **低遅延**: macOSネイティブのAPIを使用し、効率的にオーディオを取得します。
- **ハウリング防止**: 自プロセス（SAROS）の音声を自動的にキャプチャ対象から除外するため、フィードバックループが発生しません。

## 2. 使用方法

### UI操作
メインウィンドウ右上のヘッダーに追加された **[SYS AUDIO]** ボタンを使用します。

- **OFF (デフォルト)**: 通常通り、オーディオ設定で選択されたマイク/ライン入力を使用します。
- **ON (水色点灯)**: システム全体の音声をキャプチャし、入力ソースとして使用します。

### 初回設定（権限許可）
この機能を初めて有効にした際、macOSシステムによる「画面収録」の許可プロンプトが表示される場合があります。

1. **システム設定** > **プライバシーとセキュリティ** > **画面収録** を開きます。
2. **SAROS** のトグルを **ON** にします。
3. 設定変更後、アプリの再起動が必要な場合があります。

※ オーディオのみのキャプチャですが、OSのAPI分類上「画面収録」の権限が必要です。

## 3. 技術仕様

### アーキテクチャ
- **クラス構成**:
    - `SystemAudioCapturer`: 外部I/Fを提供するC++クラス。PimplイディオムでObjective-Cコードを隠蔽。
    - `AudioCaptureDelegate`: `SCStreamOutput` プロトコルを実装するObjective-Cクラス。
- **データフロー**:
    1. `SCStream` がシステムオーディオを `CMSampleBuffer` として取得。
    2. Delegateがバッファを受け取り、Float32 PCMデータを取り出し。
    3. ロックフリーなリングバッファ (`juce::AbstractFifo`) を介してオーディオスレッドへ転送。
    4. `InputManager` がリングバッファからデータを読み出し、解析/録音バッファへ注入。

### 除外設定
`SCContentFilter` の `excludingApplications` プロパティを使用する代わりに、`SCStreamConfiguration` の `excludesCurrentProcessAudio = YES` を設定することで、自プロセスの音声を除外しています。

## 4. 検証手順

### 基本動作確認
1. アプリを起動し、[SYS AUDIO] をONにする。
2. ブラウザでYouTube動画などを再生する。
3. SAROSのビジュアライザ（波形やパーティクル）が音声に合わせて反応することを確認。

### 録音テスト
1. トラックを選択し、録音（REC）を開始。
2. システム音声がクリアに録音されるか確認。
3. 再生時、ノイズや音切れがないか確認。

### ハウリング（フィードバック）テスト
1. SAROSでクリック音（メトロノーム）や、録音済みのトラックを再生する。
2. その状態で [SYS AUDIO] をONにして録音を行う。
3. **結果**: SAROS自身の音は録音されず、外部（YouTube等）の音だけが録音されれば成功。

## 5. トラブルシューティング

- **[SYS AUDIO] ボタンが反応しない**:
    - コンソールログを確認してください。macOS 13.0未満の場合、機能が無効化されています。
- **音が入力されない**:
    - 「画面収録」の権限が許可されているか再確認してください。
    - 一度機能をOFFにし、再度ONに切り替えてみてください。
