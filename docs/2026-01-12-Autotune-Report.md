# Autotune (Pitch Correction) 実装レポート

## 概要
リアルタイムで入力された音声（ボーカル等）のピッチを検出し、指定されたキーとスケールに基いて音程を自動補正するFXモジュールを実装しました。

## 実装コンポーネント

### 1. PitchDetector.h (ピッチ検出)
アルゴリズムに **YIN (Difference-based pitch estimation)** を採用しています。

*   **処理の流れ**:
    1.  **RMSチェック**: 入力信号のエネルギーが一定以下 (0.01) の場合は無音と判断し処理をスキップ。
    2.  **Difference Function**: 信号の自己相関に似た差分計算を行い、周期性を測定。
    3.  **Cumulative Mean Normalized Difference**: YIN特有の正規化により、倍音による誤検出を抑制。
    4.  **閾値判定 (0.15)**: 最初の顕著なディップ（谷）を基本周波数として抽出。
    5.  **放物線補間 (Parabolic Interpolation)**: ディップ周辺の3点から頂点を推定し、サンプリング周期以下の精度でピッチを特定。
    6.  **指数平滑化 (EMA)**: 検出された周波数を 7:3 の割合で平滑化し、ジッターを軽減。

### 2. PitchShifter.h (ピッチシフト)
時間領域での処理を行う **ディレイライン・ピッチシフター** です。

*   **技術的特徴**:
    *   **Dual Read Heads**: 2つの読み出しヘッドを使用。
    *   **Hann Window Crossfading**: ヘッドがバッファの境界でループする際、クリックノイズを防ぐためにハニング窓関数によるクロスフェードを適用。
    *   **線形補間**: 非整数位置の読み出しに対応し、滑らかな音質を維持。

## 信号処理ロジック (LooperAudio.cpp)

### スケール・スナッピング (Scale Snapping)
検出された周波数をリアルタイムでターゲット音程に変換します。

1.  周波数 ($) を MIDIノート番号へ変換： \times \log_2(freq / 440) + 69$
2.  選択された **Scales** (Chromatic, Major, Minor) の定義に基づき、指定の **Key** (C, C#, etc.) から最も近い音程を探索。
3.  ターゲット周波数と現在周波数の比率 (Pitch Ratio) を算出。
4.  **Amount (補正量)** により補正の強さを調整。
5.  **Speed (反応速度)** パラメータに基づき、比率の変化を平滑化（ポートamento/グライド効果）。

### 内部構成
*   **Mono Detection / Stereo Shifting**: 検出はL/Rのミックス（モノラル）で行い、シフト処理はステレオ独立（L/R 2つの ）で適用します。
*   **信号チェイン**: 他のエフェクト（Filter/Delay等）の直前に挿入することで、クリアなピッチ補正を実現。

## UIパラメータ (FXPanel)
*   **KEY**: 基準となるルート音を選択。
*   **SCALE**: 補正先のスケールを選択（Chromatic, Major, Minor）。
*   **AMOUNT**: 0%で補正なし、100%で完全にスケール内へ固定。
*   **SPEED**: 補正の追従速度。0に近いほど即座に変化し（ケロケロボイス）、大きくすると自然なビブラートを維持した補正が可能。

## 特筆事項
*   **低レイテンシ**: 25msのウィンドウサイズ設定により、リアルタイム演奏に支障のないレスポンスを実現。
*   **CPU効率**: 標準的な数学演算とディレイ操作のみで構成されているため、複数のトラックで同時に起動しても低負荷です。
