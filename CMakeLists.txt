cmake_minimum_required(VERSION 3.15)
project(SAROS VERSION 1.0.0)

# ğŸ Apple Silicon å‘ã‘ãƒ“ãƒ«ãƒ‰è¨­å®š (macOSã®ã¿)
if(APPLE)
    set(CMAKE_OSX_ARCHITECTURES "arm64")
endif()

# JUCEã®ãƒ‘ã‚¹è¨­å®š
# CIç’°å¢ƒã§ã¯ -DCI_BUILD=ON ã‚’æŒ‡å®šã—ã¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã®JUCEã‚’ä½¿ç”¨
# ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®JUCEãƒ‘ã‚¹ã‚’ä½¿ç”¨
option(CI_BUILD "CIç’°å¢ƒã§ã®ãƒ“ãƒ«ãƒ‰" OFF)

if(CI_BUILD)
    # CIç’°å¢ƒ: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸJUCEã‚’ä½¿ç”¨
    set(JUCE_DIR "${CMAKE_CURRENT_SOURCE_DIR}/JUCE")
else()
    # ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒ: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®JUCEãƒ‘ã‚¹ã‚’ä½¿ç”¨
    set(JUCE_DIR "/Users/mtsh/JUCE")
endif()

message(STATUS "Using JUCE from: ${JUCE_DIR}")

add_subdirectory(${JUCE_DIR} "${CMAKE_CURRENT_BINARY_DIR}/JUCE_build")

# GUIã‚¢ãƒ—ãƒªã®å®šç¾©
juce_add_gui_app(SAROS
    COMPANY_NAME "BabyLeaf"
    PRODUCT_NAME "SAROS"
    OUTPUT_NAME "SAROS"
    OUTPUT_DIRECTORY "${CMAKE_BINARY_DIR}/SAROSApp"
    ICON_BIG "${CMAKE_CURRENT_SOURCE_DIR}/Source/Assets/icon.png"
    ICON_SMALL "${CMAKE_CURRENT_SOURCE_DIR}/Source/Assets/icon.png"
)

# ğŸ†” Bundle ID ã®è¨­å®š (TCCæ¨©é™ã®å®‰å®šåŒ–ã«å¿…é ˆ)
set_target_properties(SAROS PROPERTIES
    MACOSX_BUNDLE_GUI_IDENTIFIER "com.babyleaf.saros"
    MACOSX_BUNDLE_BUNDLE_NAME "SAROS"
    MACOSX_BUNDLE_DISPLAY_NAME "SAROS"
    MACOSX_BUNDLE_INFO_STRING "SAROS Looper"
    MACOSX_BUNDLE_COPYRIGHT "Copyright (c) 2026 BabyLeaf"
)

# ãƒã‚¤ãƒŠãƒªãƒ‡ãƒ¼ã‚¿ï¼ˆãƒ•ã‚©ãƒ³ãƒˆãªã©ï¼‰ã®å®šç¾©
juce_add_binary_data(Assets
    SOURCES
        Source/Assets/Orbitron-Bold.ttf
)

set_target_properties(SAROS PROPERTIES RUNTIME_OUTPUT_DIRECTORY "${CMAKE_BINARY_DIR}/SAROSApp")

# ã‚½ãƒ¼ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«
set(SOURCE_FILES
    Source/Main.cpp
    Source/MainComponent.cpp
    Source/LooperAudio.cpp
    Source/InputManager.cpp
    Source/TransportPanel.cpp
    Source/LooperTrackUi.cpp
    Source/FXPanel.cpp
    Source/PlanetKnobLookAndFeel.cpp
    Source/MidiLearnManager.cpp
    Source/MidiLearnManager.cpp
    Source/MidiTabContent.cpp
    Source/OscDataSender.cpp
    Source/SystemAudioCapturer.h
    Source/SystemAudioCapturer.mm
    Source/AppSelectionPanel.h
    Source/AppSelectionPanel.cpp
)

set(HEADER_FILES
    Source/ThemeColours.h
    Source/Util.h
    Source/TrackUtils.h
    Source/InputManager.h
    Source/InputTap.h
    Source/LooperAudio.h
    Source/LooperTrackUi.h
    Source/TransportPanel.h
    Source/FXPanel.h
    Source/PlanetKnobLookAndFeel.h
    Source/TriggerEvent.h
    Source/SmartGate.h
    Source/MainComponent.h
    Source/RoundButtonLookAndFeel.h
    Source/CircularVisualizer.h
    Source/FilterSpectrumVisualizer.h
    Source/MidiMapping.h
    Source/MidiLearnManager.h
    Source/MidiLearnManager.h
    Source/MidiTabContent.h
    Source/OscDataSender.h
)


# MSVCå¯¾å¿œ: ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’UTF-8ã¨ã—ã¦æ‰±ã†
if (MSVC)
    target_compile_options(SAROS PRIVATE /utf-8)
endif()

target_sources(SAROS PRIVATE ${SOURCE_FILES} ${HEADER_FILES})

# ä½¿ç”¨ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«
target_link_libraries(SAROS PRIVATE
    Assets
    juce::juce_gui_basics
    juce::juce_gui_extra
    juce::juce_audio_basics
    juce::juce_audio_utils
    juce::juce_audio_devices
    juce::juce_graphics
    juce::juce_dsp
    juce::juce_core
    juce::juce_events
    juce::juce_osc
    juce::juce_opengl
    "-framework ScreenCaptureKit"
    "-framework CoreMedia"
)

# ğŸ” ãƒ“ãƒ«ãƒ‰å¾Œã«è‡ªå‹•ã‚³ãƒ¼ãƒ‰ç½²å (macOSã®ã¿)
# ç½²åIDã¯SHA-1ãƒãƒƒã‚·ãƒ¥ã§æŒ‡å®šï¼ˆç’°å¢ƒå¤‰æ•° CODESIGN_SHA1 ã‚’ä½¿ç”¨ï¼‰
# ãƒãƒƒã‚·ãƒ¥ã¯ `security find-identity -v -p codesigning` ã§ç¢ºèªå¯èƒ½
if(APPLE AND DEFINED ENV{CODESIGN_SHA1})
    add_custom_command(TARGET SAROS POST_BUILD
        COMMAND codesign --force --deep --sign $ENV{CODESIGN_SHA1} "$<TARGET_BUNDLE_DIR:SAROS>"
        COMMENT "ğŸ” Code signing SAROS.app..."
    )
elseif(APPLE)
    message(STATUS "âš ï¸ CODESIGN_SHA1 not set. Skipping code signing.")
endif()

# ğŸš€ CMake ã‹ã‚‰ç›´æ¥ã‚¢ãƒ—ãƒªã‚’èµ·å‹•ã™ã‚‹ãŸã‚ã®ã‚«ã‚¹ã‚¿ãƒ ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ
# ä½¿ç”¨æ–¹æ³•: cmake --build . --target run
if(APPLE)
    add_custom_target(run
        COMMAND open "$<TARGET_BUNDLE_DIR:SAROS>"
        DEPENDS SAROS
        COMMENT "ğŸš€ Launching SAROS.app..."
        WORKING_DIRECTORY ${CMAKE_BINARY_DIR}
    )
else()
    add_custom_target(run
        COMMAND $<TARGET_FILE:SAROS>
        DEPENDS SAROS
        COMMENT "ğŸš€ Launching SAROS..."
        WORKING_DIRECTORY ${CMAKE_BINARY_DIR}
    )
endif()

